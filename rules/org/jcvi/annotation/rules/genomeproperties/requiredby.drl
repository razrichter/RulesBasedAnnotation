#created on: Apr 6, 2010
package org.jcvi.annotation.rules.genomeproperties
import org.jcvi.annotation.facts.*;
import java.util.ArrayList;


rule "GenomeProperty value calculation"
	when
		genomeprop	 		: GenomeProperty( filled : this["filled"] )
		requiredRelations	: ArrayList()
				from collect( PropertyRelationship( subject : subject, type == RelationshipType.REQUIRED_BY, object == genomeprop ) )
		subject : Property( this == subject )		
		numFilledComponents	: Double( doubleValue != filled ) 
				from accumulate(  r : PropertyRelationship()
					from requiredRelations,
				sum( r.getSubject().getValue() ) )

 	then 
		double numRequiredComponents = new Double(requiredRelations.size());
		double fractionFilledComponents = (numRequiredComponents == 0) ? 0
								: numFilledComponents / numRequiredComponents;
		modify( genomeprop ) {
			put("required", numRequiredComponents),
			put("filled", numFilledComponents),
			setValue(fractionFilledComponents)
		};
  		System.out.println(numFilledComponents + "/" +
	  				numRequiredComponents + " = " +
	  				fractionFilledComponents + " " + 
	  				genomeprop.toString());
 end
